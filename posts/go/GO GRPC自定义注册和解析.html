<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <title>GO GRPC自定义注册和解析 | Yunshenw</title><meta name="description" content="Yunsw site">
    <link rel="preload" href="/assets/style-DverCHw7.css" as="style"><link rel="stylesheet" href="/assets/style-DverCHw7.css">
    <link rel="modulepreload" href="/assets/app-Du_kiChf.js"><link rel="modulepreload" href="/assets/GO GRPC自定义注册和解析.html-CwMxLv3A.js">
    <link rel="prefetch" href="/assets/index.html-L0fkvJHN.js" as="script"><link rel="prefetch" href="/assets/rabbitmq事务基本介绍.html-B6MnKncV.js" as="script"><link rel="prefetch" href="/assets/rabbitmq的使用场景.html-DY-Qa_VP.js" as="script"><link rel="prefetch" href="/assets/redis单线程的一点理解.html-6OoIfxgZ.js" as="script"><link rel="prefetch" href="/assets/C__编译过程.html-Bsb27N_m.js" as="script"><link rel="prefetch" href="/assets/C内存分配.html-DUynUpUd.js" as="script"><link rel="prefetch" href="/assets/C语言整数.html-DUn1n4hz.js" as="script"><link rel="prefetch" href="/assets/memset替换字符串的注意点.html-DslEnV_x.js" as="script"><link rel="prefetch" href="/assets/小程序支付.html-bnU77NHI.js" as="script"><link rel="prefetch" href="/assets/css filter的基本使用.html-BVHN66YC.js" as="script"><link rel="prefetch" href="/assets/redis-cluster.html-C1xBAPP1.js" as="script"><link rel="prefetch" href="/assets/part1.html-DE2T4rcy.js" as="script"><link rel="prefetch" href="/assets/数学累加.html-Cj5JC8Y_.js" as="script"><link rel="prefetch" href="/assets/简单的go dockerfile.html-CDfvAZFi.js" as="script"><link rel="prefetch" href="/assets/NPM Workspaces简介.html-BChMWIOK.js" as="script"><link rel="prefetch" href="/assets/URL构成.html-BPGoB48_.js" as="script"><link rel="prefetch" href="/assets/csp1.html-DfUKS4xC.js" as="script"><link rel="prefetch" href="/assets/webpack chunk.html-LooGd6oG.js" as="script"><link rel="prefetch" href="/assets/GitSubmodule.html-CwhFuuoS.js" as="script"><link rel="prefetch" href="/assets/gitlab和runner如何配置.html-CXxxhQtG.js" as="script"><link rel="prefetch" href="/assets/git子模块基本使用.html-DLotz-Zx.js" as="script"><link rel="prefetch" href="/assets/GO实现主要排序算法.html-C3L0zrp9.js" as="script"><link rel="prefetch" href="/assets/GO常量忽略的用法作用.html-djWE9MKr.js" as="script"><link rel="prefetch" href="/assets/Go结构体初始化的几种方式.html-BnZOmUM1.js" as="script"><link rel="prefetch" href="/assets/cpu的工作模式.html-B-Bt6Sed.js" as="script"><link rel="prefetch" href="/assets/etcd go的基本操作.html-ChqWLHjZ.js" as="script"><link rel="prefetch" href="/assets/etcd分布式锁.html-Bb7lZ3Ag.js" as="script"><link rel="prefetch" href="/assets/etcd和redis的使用场景及例子.html-Di_sdET6.js" as="script"><link rel="prefetch" href="/assets/go context.WithValue使用结构体作为key.html-MLSzSYNC.js" as="script"><link rel="prefetch" href="/assets/go encoding glob的使用场景和实例.html-CunS8OmZ.js" as="script"><link rel="prefetch" href="/assets/go new和make的区别.html-BLsdqddq.js" as="script"><link rel="prefetch" href="/assets/go-leaky.html-CwQmtV51.js" as="script"><link rel="prefetch" href="/assets/go-protoc-md.html-CcbVfnNz.js" as="script"><link rel="prefetch" href="/assets/go上传和接收指定文件.html-Df2r6Pj8.js" as="script"><link rel="prefetch" href="/assets/go函数体实现接口.html-D5N2CbrK.js" as="script"><link rel="prefetch" href="/assets/go字符串和字节数组的转换.html-Cy1R2X04.js" as="script"><link rel="prefetch" href="/assets/go常用写法.html-1atRhHJm.js" as="script"><link rel="prefetch" href="/assets/go接口指针的一些注意点.html-BJsNVsKW.js" as="script"><link rel="prefetch" href="/assets/go选择合适的数据存储金额.html-B91NF4rE.js" as="script"><link rel="prefetch" href="/assets/grpc的几种分类.html-D9uzhcEV.js" as="script"><link rel="prefetch" href="/assets/http协议断开时机.html-CvCz4G-T.js" as="script"><link rel="prefetch" href="/assets/k8s简介及基本操作.html-EjlAVoXI.js" as="script"><link rel="prefetch" href="/assets/menus递归的一点点改进.html-BRmy4I77.js" as="script"><link rel="prefetch" href="/assets/protoc.html-tsbjfY-K.js" as="script"><link rel="prefetch" href="/assets/tcp服务器_mac压测.html-BTTZlyVf.js" as="script"><link rel="prefetch" href="/assets/一个简单的go tcp回显服务器示例.html-CiCtYK5a.js" as="script"><link rel="prefetch" href="/assets/一致性hash.html-Ddp7COPA.js" as="script"><link rel="prefetch" href="/assets/内存基础.html-BJDuO8kC.js" as="script"><link rel="prefetch" href="/assets/基本问题.html-DoBs90g9.js" as="script"><link rel="prefetch" href="/assets/文件流式上传.html-DKhwqjcU.js" as="script"><link rel="prefetch" href="/assets/返回结构体是否该用指针.html-JOLSB9dM.js" as="script"><link rel="prefetch" href="/assets/T_ T 和 T的区别.html-BWiRRap6.js" as="script"><link rel="prefetch" href="/assets/Java注解.html-DZ1pCSTp.js" as="script"><link rel="prefetch" href="/assets/SpringBoot报错_Whitelabel Error Page_ .html-DMcpTe-k.js" as="script"><link rel="prefetch" href="/assets/SpringBoot提示_Cannot resolve symbol RestController_.html-C0dl8Csi.js" as="script"><link rel="prefetch" href="/assets/Springboot打开热部署.html-BG-Nz1WC.js" as="script"><link rel="prefetch" href="/assets/java @Async的执行.html-CrcSdSZJ.js" as="script"><link rel="prefetch" href="/assets/volatile的使用.html-CWDWmySa.js" as="script"><link rel="prefetch" href="/assets/js判断对象的三种方法.html-BjSdEuU4.js" as="script"><link rel="prefetch" href="/assets/js模拟私有变量和静态变量.html-CVFref9H.js" as="script"><link rel="prefetch" href="/assets/vue注册全局组件.html-XT71ZjTy.js" as="script"><link rel="prefetch" href="/assets/linux trap命令简介.html-InVtI_FF.js" as="script"><link rel="prefetch" href="/assets/linux-dns.html-BnhAqzP_.js" as="script"><link rel="prefetch" href="/assets/linux-route.html-BE4A6Bo5.js" as="script"><link rel="prefetch" href="/assets/linux-wifi.html-DxrXPc4Y.js" as="script"><link rel="prefetch" href="/assets/mac挂载额外盘符.html-C3M8YiSW.js" as="script"><link rel="prefetch" href="/assets/obs混流基本方案.html-BmnqWEfO.js" as="script"><link rel="prefetch" href="/assets/三种不同流媒体传输协议简介.html-5I8sjF1O.js" as="script"><link rel="prefetch" href="/assets/视频编码和视频格式的区别.html-CKgf59aX.js" as="script"><link rel="prefetch" href="/assets/主从同步过程.html-CKRzrWJj.js" as="script"><link rel="prefetch" href="/assets/NAT基本流程简述.html-Cjnlo_9p.js" as="script"><link rel="prefetch" href="/assets/创建vlan并连接到bridge.html-rc8QLMbS.js" as="script"><link rel="prefetch" href="/assets/创建网络接口并使用防火墙隔离.html-DVvBtvIM.js" as="script"><link rel="prefetch" href="/assets/创建虚拟网桥(bridge)接口.html-DSLQV6jd.js" as="script"><link rel="prefetch" href="/assets/虚拟网桥创建网络示例.html-D4f225WG.js" as="script"><link rel="prefetch" href="/assets/php调用脚本的几种方法.html-CHPd_Gk_.js" as="script"><link rel="prefetch" href="/assets/python requirements记录依赖.html-CmeN93iD.js" as="script"><link rel="prefetch" href="/assets/python反序列化字节流.html-CmrjFjW1.js" as="script"><link rel="prefetch" href="/assets/常用beautifulsoup4操作.html-B-uZD8yU.js" as="script"><link rel="prefetch" href="/assets/cat与重定向连用.html-CSeS2Svf.js" as="script"><link rel="prefetch" href="/assets/grep筛选ifconfig信息.html-CpF37W85.js" as="script"><link rel="prefetch" href="/assets/Vscode Could not create temporary directory.html-B_eU0u1o.js" as="script"><link rel="prefetch" href="/assets/CAP为什么不能同时满足.html-BeuQLYw1.js" as="script"><link rel="prefetch" href="/assets/CPU缓存一致性.html-1t3aXN8U.js" as="script"><link rel="prefetch" href="/assets/HTTP Headers之Referer.html-ClGxWZEY.js" as="script"><link rel="prefetch" href="/assets/HTTPS精要讲解.html-DDJ-ynGb.js" as="script"><link rel="prefetch" href="/assets/cdn原理示例.html-CQiAzN2M.js" as="script"><link rel="prefetch" href="/assets/docker rabbitmq集群搭建.html-BGU-KNf_.js" as="script"><link rel="prefetch" href="/assets/https(ssl)证书验证过程.html-_LHv4oDQ.js" as="script"><link rel="prefetch" href="/assets/interviewer.html-LCx1e1pp.js" as="script"><link rel="prefetch" href="/assets/rabbitmq消息的可靠性.html-DrkzJQbv.js" as="script"><link rel="prefetch" href="/assets/rabbitmq集群简介.html-BzsFpDMq.js" as="script"><link rel="prefetch" href="/assets/words.html-C7pBIwWr.js" as="script"><link rel="prefetch" href="/assets/序列化的作用.html-C3pU--fy.js" as="script"><link rel="prefetch" href="/assets/抢单的一点方案.html-CMLHIysb.js" as="script"><link rel="prefetch" href="/assets/解决ffmpeg使用nohup挂起问题.html-TgGhMc7p.js" as="script"><link rel="prefetch" href="/assets/资源覆盖率.html-C-d_OKLs.js" as="script"><link rel="prefetch" href="/assets/XSS简述.html-BfJj0k6z.js" as="script"><link rel="prefetch" href="/assets/使用OpensSSL自签名证书.html-BG7GcAgp.js" as="script"><link rel="prefetch" href="/assets/404.html-DJgVuvER.js" as="script"><link rel="prefetch" href="/assets/index.html-Cfb_bA_i.js" as="script"><link rel="prefetch" href="/assets/index.html-D9KDSUgg.js" as="script"><link rel="prefetch" href="/assets/index.html-DyCLiBXK.js" as="script"><link rel="prefetch" href="/assets/index.html-DPYyUkHk.js" as="script"><link rel="prefetch" href="/assets/index.html-D7gI0Aty.js" as="script"><link rel="prefetch" href="/assets/index.html-BZioHc4m.js" as="script"><link rel="prefetch" href="/assets/index.html-CCqsFP-f.js" as="script"><link rel="prefetch" href="/assets/index.html-0xTid1nK.js" as="script"><link rel="prefetch" href="/assets/index.html-3PaC1lug.js" as="script"><link rel="prefetch" href="/assets/index.html-CsGg38jQ.js" as="script"><link rel="prefetch" href="/assets/index.html-B94QFxVn.js" as="script"><link rel="prefetch" href="/assets/index.html-tE4YtaZc.js" as="script"><link rel="prefetch" href="/assets/index.html-1eykAv-B.js" as="script"><link rel="prefetch" href="/assets/index.html-BuoLzjEx.js" as="script"><link rel="prefetch" href="/assets/index.html-DN5aJ5H4.js" as="script"><link rel="prefetch" href="/assets/index.html-B_s9eZEb.js" as="script"><link rel="prefetch" href="/assets/index.html-Da2yoRFr.js" as="script"><link rel="prefetch" href="/assets/index.html-BjhRNDAx.js" as="script"><link rel="prefetch" href="/assets/index.html-CON4-_dq.js" as="script"><link rel="prefetch" href="/assets/index.html-jhRL8Cl-.js" as="script"><link rel="prefetch" href="/assets/index.html-BexsFWD7.js" as="script"><link rel="prefetch" href="/assets/index.html-Cs7vA9Z4.js" as="script"><link rel="prefetch" href="/assets/index.html-C_XgW2vq.js" as="script"><link rel="prefetch" href="/assets/index.html-BwsM0rQv.js" as="script"><link rel="prefetch" href="/assets/index.html-DKDqCvEm.js" as="script"><link rel="prefetch" href="/assets/index.html-DIkE41o7.js" as="script"><link rel="prefetch" href="/assets/index.html-_FNo6jBd.js" as="script"><link rel="prefetch" href="/assets/index.html-DYYLAi1S.js" as="script"><link rel="prefetch" href="/assets/index.html-BYZ_ymAx.js" as="script"><link rel="prefetch" href="/assets/index.html-lYKcQc62.js" as="script"><link rel="prefetch" href="/assets/index.html-CbmGXn41.js" as="script"><link rel="prefetch" href="/assets/index.html-_zgyTCrs.js" as="script"><link rel="prefetch" href="/assets/index.html-ChXojDV2.js" as="script"><link rel="prefetch" href="/assets/index.html-C-bCzCoX.js" as="script"><link rel="prefetch" href="/assets/index.html-oFcIhKWF.js" as="script"><link rel="prefetch" href="/assets/index.html-G9nNOojk.js" as="script"><link rel="prefetch" href="/assets/index.html-CkJ3mIZh.js" as="script"><link rel="prefetch" href="/assets/index.html-G9nNOojk.js" as="script"><link rel="prefetch" href="/assets/index.html-03jjqSZD.js" as="script"><link rel="prefetch" href="/assets/index.html-CdHCfH5u.js" as="script"><link rel="prefetch" href="/assets/index.html-DQqGFx-Z.js" as="script"><link rel="prefetch" href="/assets/index.html-DgzJSPSI.js" as="script"><link rel="prefetch" href="/assets/index.html-BaemTlIc.js" as="script"><link rel="prefetch" href="/assets/index.html-COjpTLLD.js" as="script"><link rel="prefetch" href="/assets/index.html-oFcIhKWF.js" as="script"><link rel="prefetch" href="/assets/index.html-oFcIhKWF.js" as="script"><link rel="prefetch" href="/assets/index.html-C3twLPQo.js" as="script"><link rel="prefetch" href="/assets/index.html-iCYcslsK.js" as="script"><link rel="prefetch" href="/assets/index.html-DhexBV2_.js" as="script"><link rel="prefetch" href="/assets/index.html-DPQpG83p.js" as="script"><link rel="prefetch" href="/assets/index.html-CW9RDhMi.js" as="script"><link rel="prefetch" href="/assets/index.html-D3tUwtqc.js" as="script"><link rel="prefetch" href="/assets/index.html-CS6UblBM.js" as="script"><link rel="prefetch" href="/assets/index.html-B6-Zwcg3.js" as="script"><link rel="prefetch" href="/assets/index.html-a1yhzGxU.js" as="script"><link rel="prefetch" href="/assets/index.html-CtPZm_m1.js" as="script"><link rel="prefetch" href="/assets/index.html-DZqPUOhw.js" as="script"><link rel="prefetch" href="/assets/index.html-jDxcnjqf.js" as="script"><link rel="prefetch" href="/assets/index.html-DNklYpV8.js" as="script"><link rel="prefetch" href="/assets/index.html-C0oarTZD.js" as="script"><link rel="prefetch" href="/assets/index.html-duChX3Xl.js" as="script"><link rel="prefetch" href="/assets/index.html-BDtG2Yxo.js" as="script"><link rel="prefetch" href="/assets/index.html-DQ7aLEwe.js" as="script"><link rel="prefetch" href="/assets/index.html-BPV8tXmV.js" as="script"><link rel="prefetch" href="/assets/index.html-DHkM6GXX.js" as="script"><link rel="prefetch" href="/assets/index.html-O3V10WJ_.js" as="script"><link rel="prefetch" href="/assets/index.html-B-YSAeCJ.js" as="script"><link rel="prefetch" href="/assets/index.html-CQCU7z1q.js" as="script"><link rel="prefetch" href="/assets/index.html-DHCGWxVo.js" as="script"><link rel="prefetch" href="/assets/index.html-C835_Wh5.js" as="script"><link rel="prefetch" href="/assets/index.html-DBuQWVh-.js" as="script"><link rel="prefetch" href="/assets/index.html-CKMMano9.js" as="script"><link rel="prefetch" href="/assets/index.html-HFK31TZ1.js" as="script"><link rel="prefetch" href="/assets/index.html-BshOuuS_.js" as="script"><link rel="prefetch" href="/assets/index.html-C2uWaldr.js" as="script"><link rel="prefetch" href="/assets/index.html-dl9Q6Xcm.js" as="script"><link rel="prefetch" href="/assets/index.html-DXWXKDLf.js" as="script"><link rel="prefetch" href="/assets/index.html-CYi-F_vK.js" as="script"><link rel="prefetch" href="/assets/index.html-B2LUDWc7.js" as="script"><link rel="prefetch" href="/assets/index.html-P1T4no-E.js" as="script"><link rel="prefetch" href="/assets/index.html-Dt9kj8x_.js" as="script"><link rel="prefetch" href="/assets/index.html-Bw2D7W08.js" as="script"><link rel="prefetch" href="/assets/index.html-k5rEs6pb.js" as="script"><link rel="prefetch" href="/assets/index.html-BegTa4o9.js" as="script"><link rel="prefetch" href="/assets/index.html-DKal99hr.js" as="script"><link rel="prefetch" href="/assets/index.html-CagOltQS.js" as="script"><link rel="prefetch" href="/assets/index.html-C-d0u_A8.js" as="script"><link rel="prefetch" href="/assets/index.html-2jOzTAoI.js" as="script"><link rel="prefetch" href="/assets/index.html-ftIpxHs7.js" as="script"><link rel="prefetch" href="/assets/index.html-BPVJL59z.js" as="script"><link rel="prefetch" href="/assets/index.html-DjVv6sXK.js" as="script"><link rel="prefetch" href="/assets/index.html-3zkgCwbw.js" as="script"><link rel="prefetch" href="/assets/index.html-T0FG1HCx.js" as="script"><link rel="prefetch" href="/assets/index.html-B1YL81Qo.js" as="script"><link rel="prefetch" href="/assets/index.html-1B8iXacg.js" as="script"><link rel="prefetch" href="/assets/index.html-JFldorzG.js" as="script"><link rel="prefetch" href="/assets/index.html-Dw5xZB4v.js" as="script"><link rel="prefetch" href="/assets/index.html-CrYcq5uj.js" as="script"><link rel="prefetch" href="/assets/index.html-D3Y1ngIc.js" as="script"><link rel="prefetch" href="/assets/index.html-D4ktFPOA.js" as="script"><link rel="prefetch" href="/assets/index.html-ChdMFVqM.js" as="script"><link rel="prefetch" href="/assets/index.html-B0vpoifD.js" as="script"><link rel="prefetch" href="/assets/index.html-DTngdVTx.js" as="script"><link rel="prefetch" href="/assets/index.html-BAyU5nhw.js" as="script"><link rel="prefetch" href="/assets/index.html-BsILuhxc.js" as="script"><link rel="prefetch" href="/assets/index.html-BocSdCAj.js" as="script"><link rel="prefetch" href="/assets/index.html-BM9gRFLq.js" as="script"><link rel="prefetch" href="/assets/index.html-DOVrjqdi.js" as="script"><link rel="prefetch" href="/assets/index.html-BuNR7JkV.js" as="script"><link rel="prefetch" href="/assets/index.html-Bwt1y73H.js" as="script"><link rel="prefetch" href="/assets/index.html-CmjyNBfH.js" as="script"><link rel="prefetch" href="/assets/index.html-DevdY8OR.js" as="script"><link rel="prefetch" href="/assets/index.html-DQGrXIFH.js" as="script"><link rel="prefetch" href="/assets/index.html-eK1NVESR.js" as="script"><link rel="prefetch" href="/assets/index.html-CrLr2n2Q.js" as="script"><link rel="prefetch" href="/assets/index.html-Di1llngd.js" as="script"><link rel="prefetch" href="/assets/index.html-DioFJXXd.js" as="script"><link rel="prefetch" href="/assets/index.html-CPZ_hEJX.js" as="script"><link rel="prefetch" href="/assets/index.html-CiqIHPr9.js" as="script"><link rel="prefetch" href="/assets/index.html-DiwK6jCR.js" as="script"><link rel="prefetch" href="/assets/index.html-BZsEUV-g.js" as="script"><link rel="prefetch" href="/assets/index.html-iMGCIuKn.js" as="script"><link rel="prefetch" href="/assets/index.html-BuKv_xPa.js" as="script"><link rel="prefetch" href="/assets/index.html-D_T9raTj.js" as="script"><link rel="prefetch" href="/assets/index.html-UdRg_wd8.js" as="script"><link rel="prefetch" href="/assets/index.html-DP3sEx5X.js" as="script"><link rel="prefetch" href="/assets/index.html-CE7lL2gW.js" as="script"><link rel="prefetch" href="/assets/index.html-9npyMNUO.js" as="script"><link rel="prefetch" href="/assets/index.html-C2rlUdN6.js" as="script"><link rel="prefetch" href="/assets/index.html-BmAoy5k7.js" as="script"><link rel="prefetch" href="/assets/SearchResult-7h7KiU6s.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/article/"><img class="logo" src="/logo.png" alt="Yunshenw"><span class="site-name can-hide" aria-hidden="true">Yunshenw</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/article/" aria-label="文章"><!--[--><!--[--><!--]--> 文章 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/category/" aria-label="分类"><!--[--><!--[--><!--]--> 分类 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/tag/" aria-label="标签"><!--[--><!--[--><!--]--> 标签 <!--[--><!--]--><!--]--></a></div><div class="navbar-item"><a class="route-link" href="/timeline/" aria-label="时间线"><!--[--><!--[--><!--]--> 时间线 <!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">GO GRPC自定义注册和解析 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#实现自定义注册逻辑-etcd版" aria-label="实现自定义注册逻辑(ETCD版)"><!--[--><!--[--><!--]--> 实现自定义注册逻辑(ETCD版) <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#实现自定义解析器-resolver" aria-label="实现自定义解析器(Resolver)"><!--[--><!--[--><!--]--> 实现自定义解析器(Resolver) <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#_1-实现-resolver-builder-接口" aria-label="1. 实现 resolver.Builder 接口"><!--[--><!--[--><!--]--> 1. 实现 resolver.Builder 接口 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_2-实现-resolver-resolver-接口" aria-label="2. 实现 resolver.Resolver 接口"><!--[--><!--[--><!--]--> 2. 实现 resolver.Resolver 接口 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_3-注册自定义-builder" aria-label="3. 注册自定义 Builder"><!--[--><!--[--><!--]--> 3. 注册自定义 Builder <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#详细叙述每一步的意义" aria-label="详细叙述每一步的意义："><!--[--><!--[--><!--]--> 详细叙述每一步的意义： <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#代码示例" aria-label="代码示例"><!--[--><!--[--><!--]--> 代码示例 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#resolver-clientconn的作用" aria-label="resolver.ClientConn的作用"><!--[--><!--[--><!--]--> resolver.ClientConn的作用 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#clientconn-接口的作用" aria-label="ClientConn 接口的作用"><!--[--><!--[--><!--]--> ClientConn 接口的作用 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#注释的含义" aria-label="注释的含义"><!--[--><!--[--><!--]--> 注释的含义 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#为什么用回调函数" aria-label="为什么用回调函数"><!--[--><!--[--><!--]--> 为什么用回调函数 <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="#解析器为什么不设计成实现一个接口" aria-label="解析器为什么不设计成实现一个接口"><!--[--><!--[--><!--]--> 解析器为什么不设计成实现一个接口 <!--[--><!--]--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="#_1-分离构建与解析逻辑" aria-label="1. 分离构建与解析逻辑"><!--[--><!--[--><!--]--> 1. 分离构建与解析逻辑 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_2-提高扩展性和灵活性" aria-label="2. 提高扩展性和灵活性"><!--[--><!--[--><!--]--> 2. 提高扩展性和灵活性 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_3-降低复杂性和提高可维护性" aria-label="3. 降低复杂性和提高可维护性"><!--[--><!--[--><!--]--> 3. 降低复杂性和提高可维护性 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_4-适应不同的使用场景" aria-label="4. 适应不同的使用场景"><!--[--><!--[--><!--]--> 4. 适应不同的使用场景 <!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="#_5-符合设计模式的最佳实践" aria-label="5. 符合设计模式的最佳实践"><!--[--><!--[--><!--]--> 5. 符合设计模式的最佳实践 <!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="实现自定义注册逻辑-etcd版" tabindex="-1"><a class="header-anchor" href="#实现自定义注册逻辑-etcd版"><span>实现自定义注册逻辑(ETCD版)</span></a></h2><p>实现自定义注册逻辑相对自由，没有接口实现的限制：</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> registrar

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	clientv3 <span class="token string">&quot;go.etcd.io/etcd/client/v3&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> EtcdRegistrar <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	client  <span class="token operator">*</span>clientv3<span class="token punctuation">.</span>Client
	leaseId clientv3<span class="token punctuation">.</span>LeaseID
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewEtcdRegistrar</span><span class="token punctuation">(</span>endpoints <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>EtcdRegistrar <span class="token punctuation">{</span>
	cli<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientv3<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>clientv3<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Endpoints<span class="token punctuation">:</span>   endpoints<span class="token punctuation">,</span>
		DialTimeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to connect to etcd: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>EtcdRegistrar<span class="token punctuation">{</span>
		client<span class="token punctuation">:</span> cli<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 往etcd注册服务名-地址</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>EtcdRegistrar<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>serviceName <span class="token builtin">string</span><span class="token punctuation">,</span> addr <span class="token builtin">string</span><span class="token punctuation">,</span> ttl <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	leaseResp<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Grant</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	r<span class="token punctuation">.</span>leaseId <span class="token operator">=</span> leaseResp<span class="token punctuation">.</span>ID

	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> r<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;/%s/%s&quot;</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> clientv3<span class="token punctuation">.</span><span class="token function">WithLease</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>leaseId<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="实现自定义解析器-resolver" tabindex="-1"><a class="header-anchor" href="#实现自定义解析器-resolver"><span>实现自定义解析器(Resolver)</span></a></h2><p>要实现 gRPC 中的自定义 <code>Resolver</code>，你需要遵循以下步骤：</p><h3 id="_1-实现-resolver-builder-接口" tabindex="-1"><a class="header-anchor" href="#_1-实现-resolver-builder-接口"><span>1. 实现 <code>resolver.Builder</code> 接口</span></a></h3><h4 id="接口签名" tabindex="-1"><a class="header-anchor" href="#接口签名"><span>接口签名</span></a></h4><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Builder creates a resolver that will be used to watch name resolution updates.</span>
<span class="token keyword">type</span> Builder <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Build creates a new resolver for the given target.</span>
	<span class="token comment">//</span>
	<span class="token comment">// gRPC dial calls Build synchronously, and fails if the returned error is</span>
	<span class="token comment">// not nil.</span>
	<span class="token function">Build</span><span class="token punctuation">(</span>target Target<span class="token punctuation">,</span> cc ClientConn<span class="token punctuation">,</span> opts BuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>Resolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// Scheme returns the scheme supported by this resolver.  Scheme is defined</span>
	<span class="token comment">// at https://github.com/grpc/grpc/blob/master/doc/naming.md.  The returned</span>
	<span class="token comment">// string should not contain uppercase characters, as they will not match</span>
	<span class="token comment">// the parsed target&#39;s scheme as defined in RFC 3986.</span>
	<span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>目的</strong>：<code>Builder</code> 接口用于创建 <code>Resolver</code> 实例。</li><li><strong>方法</strong>： <ul><li><code>Build(target resolver.Target, cc resolver.ClientConn, opts resolver.BuildOptions) (resolver.Resolver, error)</code>: 根据给定的目标地址、客户端连接接口和构建选项来创建 <code>Resolver</code>。</li><li><code>Scheme() string</code>: 返回这个 <code>Builder</code> 支持的方案（scheme）名称，例如 <code>&quot;myScheme&quot;</code>。</li></ul></li></ul><h3 id="_2-实现-resolver-resolver-接口" tabindex="-1"><a class="header-anchor" href="#_2-实现-resolver-resolver-接口"><span>2. 实现 <code>resolver.Resolver</code> 接口</span></a></h3><h4 id="接口签名-1" tabindex="-1"><a class="header-anchor" href="#接口签名-1"><span>接口签名</span></a></h4><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// Resolver watches for the updates on the specified target.</span>
<span class="token comment">// Updates include address updates and service config updates.</span>
<span class="token keyword">type</span> Resolver <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// ResolveNow will be called by gRPC to try to resolve the target name</span>
	<span class="token comment">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.</span>
	<span class="token comment">//</span>
	<span class="token comment">// It could be called multiple times concurrently.</span>
	<span class="token function">ResolveNow</span><span class="token punctuation">(</span>ResolveNowOptions<span class="token punctuation">)</span>
	<span class="token comment">// Close closes the resolver.</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>目的</strong>：<code>Resolver</code> 接口定义了解析器如何监视目标地址的更新。</li><li><strong>方法</strong>： <ul><li><code>ResolveNow(resolver.ResolveNowOptions)</code>: 当 gRPC 客户端需要立即解析目标地址时，该方法会被调用。</li><li><code>Close()</code>: 当解析器不再需要时，清理资源。</li></ul></li></ul><h3 id="_3-注册自定义-builder" tabindex="-1"><a class="header-anchor" href="#_3-注册自定义-builder"><span>3. 注册自定义 <code>Builder</code></span></a></h3><ul><li><strong>操作</strong>：使用 <code>resolver.Register()</code> 函数注册你的自定义 <code>Builder</code>。</li><li><strong>示例</strong>：<div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MyResolverBuilder<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="详细叙述每一步的意义" tabindex="-1"><a class="header-anchor" href="#详细叙述每一步的意义"><span>详细叙述每一步的意义：</span></a></h3><h4 id="实现-resolver-builder-接口" tabindex="-1"><a class="header-anchor" href="#实现-resolver-builder-接口"><span>实现 <code>resolver.Builder</code> 接口</span></a></h4><ul><li>这一步是定义如何构建你的自定义解析器的逻辑。<code>Build</code> 方法是创建和初始化 <code>Resolver</code> 实例的关键，它接收目标地址和客户端连接，返回一个 <code>Resolver</code>。<code>Scheme</code> 方法定义了你的解析器将要处理的 URI 方案（scheme），它在 URI 中用于标识使用哪个解析器。</li></ul><h4 id="实现-resolver-resolver-接口" tabindex="-1"><a class="header-anchor" href="#实现-resolver-resolver-接口"><span>实现 <code>resolver.Resolver</code> 接口</span></a></h4><ul><li>这一步是定义解析器的行为。<code>Resolver</code> 负责实际的地址解析逻辑，包括如何响应解析请求和何时更新地址信息。<code>ResolveNow</code> 方法提供了一种机制，让 gRPC 客户端可以要求解析器立即进行解析操作。<code>Close</code> 方法则用于当解析器被废弃时的资源清理工作。</li></ul><h4 id="注册自定义-builder" tabindex="-1"><a class="header-anchor" href="#注册自定义-builder"><span>注册自定义 <code>Builder</code></span></a></h4><ul><li>通过注册过程，你的 <code>Builder</code> 实现被添加到 gRPC 的解析器注册表中。这样，当 gRPC 客户端遇到使用你的方案（scheme）的 URI 时，就会使用你的解析器来处理。注册通常在包的 <code>init</code> 函数中完成，以确保在程序启动时自动进行。</li></ul><h3 id="代码示例" tabindex="-1"><a class="header-anchor" href="#代码示例"><span>代码示例</span></a></h3><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token keyword">package</span> resolver

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	clientv3 <span class="token string">&quot;go.etcd.io/etcd/client/v3&quot;</span>
	<span class="token string">&quot;google.golang.org/grpc/resolver&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> etcdResolver <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	serviceName <span class="token builtin">string</span>
	client      <span class="token operator">*</span>clientv3<span class="token punctuation">.</span>Client
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewEtcdResolver</span><span class="token punctuation">(</span>endpoints <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> serviceName <span class="token builtin">string</span><span class="token punctuation">)</span> resolver<span class="token punctuation">.</span>Builder <span class="token punctuation">{</span>
	cli<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientv3<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>clientv3<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Endpoints<span class="token punctuation">:</span>   endpoints<span class="token punctuation">,</span>
		DialTimeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to connect to etcd: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>etcdResolver<span class="token punctuation">{</span>
		serviceName<span class="token punctuation">:</span> serviceName<span class="token punctuation">,</span>
		client<span class="token punctuation">:</span>      cli<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>etcdResolver<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span>target resolver<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> cc resolver<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> opts resolver<span class="token punctuation">.</span>BuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>Resolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	prefix <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;/%s/&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>serviceName<span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;prefix&quot;</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> clientv3<span class="token punctuation">.</span><span class="token function">WithPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> addresses <span class="token punctuation">[</span><span class="token punctuation">]</span>resolver<span class="token punctuation">.</span>Address
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> kv <span class="token operator">:=</span> <span class="token keyword">range</span> resp<span class="token punctuation">.</span>Kvs <span class="token punctuation">{</span>
		addr <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;addr&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		addresses <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>addresses<span class="token punctuation">,</span> resolver<span class="token punctuation">.</span>Address<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// 调用resolver.ClientConn通知客户端地址改变</span>
	cc<span class="token punctuation">.</span><span class="token function">UpdateState</span><span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>State<span class="token punctuation">{</span>Addresses<span class="token punctuation">:</span> addresses<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">nil</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>etcdResolver<span class="token punctuation">)</span> <span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>                          <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;etcd&quot;</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>etcdResolver<span class="token punctuation">)</span> <span class="token function">ResolveNow</span><span class="token punctuation">(</span>o resolver<span class="token punctuation">.</span>ResolveNowOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>etcdResolver<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="resolver-clientconn的作用" tabindex="-1"><a class="header-anchor" href="#resolver-clientconn的作用"><span><code>resolver.ClientConn</code>的作用</span></a></h3><p>在 gRPC 中，<code>ClientConn</code> 接口在自定义解析器的上下文中扮演着重要的角色。这个接口为解析器提供了一种与 gRPC 客户端连接（ClientConn）进行交互的机制。通过这个接口，解析器能够通知 gRPC 客户端关于服务地址或服务配置的任何更新。</p><h3 id="clientconn-接口的作用" tabindex="-1"><a class="header-anchor" href="#clientconn-接口的作用"><span><code>ClientConn</code> 接口的作用</span></a></h3><ol><li><p><strong>更新通知</strong>:</p><ul><li><code>ClientConn</code> 接口包含一组回调函数，这些回调使得解析器能够将服务发现的结果或变化通知给 gRPC 客户端连接。</li><li>例如，当解析器发现新的服务地址时，它可以使用这些回调来更新 gRPC 客户端的连接信息。</li></ul></li><li><p><strong>服务地址和配置管理</strong>:</p><ul><li>解析器通过 <code>ClientConn</code> 接口通知 gRPC 客户端有关服务地址的新信息或变更，以及任何相关的服务配置。</li><li>这包括添加新的服务地址、删除旧的服务地址或更新服务配置。</li></ul></li></ol><h3 id="注释的含义" tabindex="-1"><a class="header-anchor" href="#注释的含义"><span>注释的含义</span></a></h3><p>当注释说“ClientConn contains the callbacks for resolver to notify any updates to the gRPC ClientConn”，这意味着：</p><ul><li><code>ClientConn</code> 接口内部定义了一组回调函数。</li><li>这些回调函数是由解析器调用的，用于将关于服务地址或配置的更新传递给 gRPC 客户端连接。</li><li>解析器利用这些回调来告知 gRPC 客户端它需要知道的任何重要信息，如地址更改、服务配置更新等。</li></ul><h3 id="为什么用回调函数" tabindex="-1"><a class="header-anchor" href="#为什么用回调函数"><span>为什么用回调函数</span></a></h3><p>使用回调函数的设计允许解析器在有新的信息时主动通知 gRPC 客户端，而不是让客户端定期轮询解析器以获取更新。这种推送机制更高效，能够确保 gRPC 客户端及时获得最新的服务信息，从而做出快速响应。</p><p>这个机制对于实现动态服务发现和负载均衡特别重要，因为服务实例可能会经常变化，而客户端需要即时获得这些变化的信息以保持连接的有效性和优化性能。</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><pre class="language-go"><code><span class="token comment">// ClientConn 包含解析器用来通知 gRPC ClientConn 任何更新的回调函数。</span>
<span class="token comment">//</span>
<span class="token comment">// 这个接口由 gRPC 实现。用户通常不需要全新实现这个接口。像测试这样的情况下，</span>
<span class="token comment">// 新的实现应该嵌入这个接口。这允许 gRPC 向这个接口添加新的方法。</span>
<span class="token keyword">type</span> ClientConn <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// UpdateState 根据需要更新 ClientConn 的状态。</span>
    <span class="token comment">//</span>
    <span class="token comment">// 如果返回错误，解析器应该再次尝试解析目标。解析器应该使用回退计时器</span>
    <span class="token comment">// 避免对服务器请求过载。如果解析器确信重新解析不会改变结果，</span>
    <span class="token comment">// 比如因为它是基于监视的解析器，返回的错误可以被忽略。</span>
    <span class="token comment">//</span>
    <span class="token comment">// 如果解析出的 State 与上次报告的相同，可以省略调用 UpdateState。</span>
    <span class="token function">UpdateState</span><span class="token punctuation">(</span>State<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token comment">// ReportError 通知 ClientConn 解析器遇到了错误。ClientConn 将通知负载均衡器，</span>
    <span class="token comment">// 并开始以指数回退的方式调用解析器的 ResolveNow。</span>
    <span class="token function">ReportError</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span>
    <span class="token comment">// NewAddress 由解析器调用，用于通知 ClientConn 一组新解析出的地址。</span>
    <span class="token comment">// 地址列表应该是完整的解析地址列表。</span>
    <span class="token comment">//</span>
    <span class="token comment">// 已废弃：请改用 UpdateState。</span>
    <span class="token function">NewAddress</span><span class="token punctuation">(</span>addresses <span class="token punctuation">[</span><span class="token punctuation">]</span>Address<span class="token punctuation">)</span>
    <span class="token comment">// NewServiceConfig 由解析器调用，用于通知 ClientConn 一个新的服务配置。</span>
    <span class="token comment">// 服务配置应以 json 字符串形式提供。</span>
    <span class="token comment">//</span>
    <span class="token comment">// 已废弃：请改用 UpdateState。</span>
    <span class="token function">NewServiceConfig</span><span class="token punctuation">(</span>serviceConfig <span class="token builtin">string</span><span class="token punctuation">)</span>
    <span class="token comment">// ParseServiceConfig 解析提供的服务配置，并返回一个提供解析配置的对象。</span>
    <span class="token function">ParseServiceConfig</span><span class="token punctuation">(</span>serviceConfigJSON <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>serviceconfig<span class="token punctuation">.</span>ParseResult
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="解析器为什么不设计成实现一个接口" tabindex="-1"><a class="header-anchor" href="#解析器为什么不设计成实现一个接口"><span>解析器为什么不设计成实现一个接口</span></a></h2><p>将 <code>resolver.Builder</code> 和 <code>resolver.Resolver</code> 分成两个不同的接口是为了分离关注点，提高代码的模块化和灵活性。这种设计模式允许更清晰地定义每个接口的职责，并使得代码更易于维护和扩展。下面详细解释这样设计的意义：</p><h3 id="_1-分离构建与解析逻辑" tabindex="-1"><a class="header-anchor" href="#_1-分离构建与解析逻辑"><span>1. 分离构建与解析逻辑</span></a></h3><ul><li><strong><code>resolver.Builder</code></strong> 负责创建 <code>resolver.Resolver</code> 的实例。它的主要作用是根据给定的目标地址和构建选项来“构建”或“创建”一个新的解析器。</li><li><strong><code>resolver.Resolver</code></strong> 负责实际的地址解析工作。它需要持续运行，监听地址的变化，并在必要时更新地址信息。</li></ul><p>这种分离确保了解析器的创建和解析逻辑可以独立变化和优化，而不会相互影响。</p><h3 id="_2-提高扩展性和灵活性" tabindex="-1"><a class="header-anchor" href="#_2-提高扩展性和灵活性"><span>2. 提高扩展性和灵活性</span></a></h3><ul><li>通过分开的接口，可以在不修改现有 <code>Resolver</code> 实现的情况下，添加新的 <code>Builder</code> 来支持不同的解析策略或配置。</li><li>这种设计使得添加新的解析器类型或更改解析器的创建逻辑变得更加灵活。</li></ul><h3 id="_3-降低复杂性和提高可维护性" tabindex="-1"><a class="header-anchor" href="#_3-降低复杂性和提高可维护性"><span>3. 降低复杂性和提高可维护性</span></a></h3><ul><li>将复杂的功能分解成更小、更专注的部分，可以降低单个组件的复杂性。</li><li>每个接口专注于一组明确的职责，使得代码更容易理解和维护。</li></ul><h3 id="_4-适应不同的使用场景" tabindex="-1"><a class="header-anchor" href="#_4-适应不同的使用场景"><span>4. 适应不同的使用场景</span></a></h3><ul><li>在某些情况下，可能需要根据运行时的具体条件动态创建不同类型的解析器。<code>Builder</code> 接口允许在运行时根据需要构建适当的 <code>Resolver</code> 实例。</li></ul><h3 id="_5-符合设计模式的最佳实践" tabindex="-1"><a class="header-anchor" href="#_5-符合设计模式的最佳实践"><span>5. 符合设计模式的最佳实践</span></a></h3><ul><li>这种设计模式类似于工厂模式，其中 <code>Builder</code> 充当工厂，负责创建 <code>Resolver</code> 对象。这是一种常见的设计模式，用于创建对象，尤其是在对象的创建过程比较复杂或需要依据不同条件创建不同类型的对象时。</li></ul><p>总的来说，通过将 <code>Builder</code> 和 <code>Resolver</code> 分成两个接口，gRPC 的设计者能够提供一个既灵活又易于管理的解析器架构，使得开发者可以根据自己的需求定制服务发现和地址解析的行为。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 85443289+yushenw@users.noreply.github.com">yushen</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-Du_kiChf.js" defer></script>
  </body>
</html>
