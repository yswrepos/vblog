---
title: NAT基本流程简述
date: 2024-02-27 23:53:28
tags:
  - net
  - nat
categories: net
---
路由器通过使用NAT（网络地址转换）机制来区分并正确地将入站的数据包路由到内部网络中的特定设备（如设备A或设备B）。这里涉及两个关键概念：NAT表和端口号。

### NAT表
NAT表是路由器用来跟踪内部网络设备（私有IP地址）与其对应的外部通信会话的关键数据结构。当设备A和设备B向外部世界发送数据包时，路由器会在NAT表中创建条目，记录以下信息：

- **内部源IP地址**：发送数据包的设备的私有IP地址。
- **内部源端口**：发送数据包使用的端口号。
- **外部源IP地址**：路由器的公共IP地址（NAT转换后的地址）。
- **外部源端口**：路由器分配给该会话的唯一端口号，用于区分不同的通信会话。

### 端口号的作用
当路由器将内部IP地址转换为公共IP地址时，它会为每个会话分配一个唯一的外部端口号。这样，当从外部网络返回的数据包到达路由器时，路由器会查看该数据包的目标端口号，并通过NAT表中的映射来确定这个数据包应该被发送到内部网络中的哪个设备。

### 数据包路由的例子
假设设备A（私有IP：192.168.1.10）和设备B（私有IP：192.168.1.11）分别与互联网上的服务器建立了通信会话。设备A可能使用端口12345与外部世界通信，而设备B使用端口54321。当这些设备通过路由器发送数据包时，路由器将使用其公共IP地址（假设为198.51.100.1），但为每个会话分配不同的外部端口号（例如，设备A的会话可能使用端口10000，设备B的会话使用端口20000）。

- **入站数据包到设备A**：当服务器回复设备A的请求，发送数据包到198.51.100.1:10000时，路由器检查NAT表，发现这个端口号与设备A的通信会话匹配，然后将数据包的目标IP和端口转换为192.168.1.10:12345，并转发给设备A。
- **入站数据包到设备B**：类似地，如果服务器发送数据包到198.51.100.1:20000作为回复给设备B，路由器同样查看NAT表，识别这个端口号与设备B的通信会话匹配，随后将数据包的目标IP和端口转换为192.168.1.11:54321，并转发给设备B。

<!-- more -->

通过这种方式，即使所有入站数据包的目标IP地址都是路由器的公共地址，路由器也能通过端口号准确地将数据包分发到正确的内部设备。这就是NAT如何使得多个设备共享一个公共IP地址进行互联网通信的同时，还能保证数据包正确路由的基本原理。
