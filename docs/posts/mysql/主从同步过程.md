---
title: 主从同步过程
date: 2024-03-25 16:22:07
tags: 
 - mysql 
categories: mysql
---

MySQL的主从同步过程涉及将主服务器（Master）上的数据变更复制到一个或多个从服务器（Slave）上，以保持数据库的一致性。这个过程主要通过二进制日志（Binary Log）和中继日志（Relay Log）实现。下面是一个详细的步骤描述，包括当一个SQL插入语句在主服务器上执行时发生的事情：

### 1. SQL插入操作在主服务器上执行

当一个插入（INSERT）语句在主服务器上执行时：

1. **执行语句**：MySQL首先执行这个插入语句，将新的数据行添加到相应的表中。
2. **写入二进制日志**：执行的插入语句和所产生的数据变更被记录到主服务器的二进制日志中。二进制日志是MySQL数据修改的记录，包括但不限于插入、更新和删除操作。

### 2. 从服务器请求数据变更

从服务器通过以下步骤与主服务器同步数据：

1. **读取二进制日志**：从服务器上的I/O线程连接到主服务器，并请求从上次同步后的二进制日志位置开始的所有新的二进制日志条目。
2. **接收并写入中继日志**：从服务器接收到二进制日志后，I/O线程会将这些日志写入本地的中继日志（Relay Log）。中继日志是从服务器上的二进制日志的一个副本。

### 3. 应用数据变更到从服务器

从服务器将二进制日志中的数据变更应用到自己的数据库中：

1. **读取中继日志**：从服务器上的SQL线程读取中继日志中的事件。
2. **执行日志事件**：SQL线程执行中继日志中的事件，包括插入操作，将数据变更应用到从服务器的数据库中。

### 4. 完成同步

一旦SQL线程完成了中继日志中所有事件的执行，这次的数据同步过程就完成了。此时，从服务器上的数据应该与主服务器上的数据保持一致。

### 同步模式

MySQL支持几种不同的复制模式，主要包括同步复制（Synchronous Replication）和异步复制（Asynchronous Replication）。在默认配置下，MySQL使用的是异步复制，这意味着主服务器在将事件写入二进制日志后就立即返回，不会等待从服务器确认已接收和应用了这些变更。这可能导致在某些情况下（如主服务器突然崩溃）主从数据不一致的情况。为了解决这个问题，MySQL还提供了半同步复制（Semi-Synchronous Replication）作为一种可选配置，以提高数据一致性。

### 注意事项

- **数据延迟**：在高负载或网络延迟的情况下，从服务器可能会与主服务器出现延时，即从服务器上的数据可能暂时落后于主服务器。
- **配置和监控**：正确配置主从复制并监控复制过程对于确保数据的一致性和可用性至关重要。

通过上述过程，MySQL的主从复制提供了一种强大的机制来增强数据的可用性和读取性能，同时为数据备份和灾难恢复提供支持。
<!-- more -->

## 半同步复制

半同步复制（Semi-Synchronous Replication）是MySQL中的一种数据复制模式，它介于全同步复制和异步复制之间。这种复制模式旨在平衡数据一致性和复制延迟之间的关系，以提高数据的可靠性而不会显著影响主服务器的性能。

### 工作原理

在半同步复制模式下：

- 当主服务器执行一个事务并将其写入二进制日志后，它会等待至少一个从服务器确认它已经收到了该事务的信息，并将其写入自己的中继日志（但不需要该事务已经被应用）。
- 主服务器在收到至少一个从服务器的确认后，才会继续处理下一个事务。
- 如果在指定的等待时间内没有从服务器响应，复制将退回到异步模式，主服务器不再等待从服务器的确认。这是为了确保在从服务器无法及时响应时，不会阻塞主服务器上的事务处理。

### 优点

- **提高数据一致性**：半同步复制确保了至少一个从服务器已经接收到了事务数据，这减少了主服务器突然宕机时数据丢失的风险。
- **平衡性能与一致性**：与全同步复制相比，半同步复制在确保数据一致性的同时，减少了等待所有从服务器确认的需求，从而平衡了性能与一致性的需求。

### 缺点

- **可能的性能影响**：尽管半同步复制减少了全同步复制的性能开销，但它仍然可能引入比异步复制更高的延迟，因为主服务器需要等待至少一个从服务器的确认。
- **复杂的配置和管理**：启用半同步复制需要对MySQL进行额外的配置，并且可能需要根据具体场景调整参数以获得最佳的性能和可靠性平衡。

### 使用场景

半同步复制适用于那些对数据一致性要求较高，但又不能接受全同步复制可能带来的性能损失的场景。例如，金融服务、电子商务平台和其他需要确保数据不丢失，同时又要求系统具有较好响应性能的应用，可以考虑使用半同步复制。

### 配置

在MySQL中启用半同步复制需要安装并配置半同步复制插件，并调整相关参数以启用这一功能。具体的配置步骤可能根据MySQL的版本和具体的部署环境有所不同。


## 主从复制过程


在MySQL主从复制架构中，从服务器知道主服务器二进制日志有更新并同步到中继日志的过程是通过持续的通信和协调实现的。这个过程主要涉及两个关键组件：从服务器的I/O线程和主服务器的二进制日志。下面是详细的说明：

### 1. 建立复制连接

- **开始复制时**：复制初始化时，从服务器上的I/O线程会连接到主服务器。这一步通常在从服务器上配置复制并启动复制过程时发生，需要指定主服务器的地址、端口以及用于复制的用户凭证。

### 2. 读取二进制日志位置

- **同步点**：当从服务器的I/O线程首次连接到主服务器时，它会告知主服务器最后同步的二进制日志文件和位置（也就是它上次复制到哪里）。如果是初次复制，这通常是主服务器当前二进制日志的起始位置。

### 3. 请求和接收二进制日志事件

- **持续监听**：一旦初始化复制，从服务器的I/O线程会持续监听主服务器上的二进制日志变更。主服务器在执行完事务并将其写入二进制日志后，会将这些日志事件发送给所有请求这些信息的从服务器。
- **发送更新**：主服务器上有一个专门的线程负责将二进制日志的更新发送给从服务器。每当二进制日志有新的事件时，主服务器就会将这些事件发送给所有连接的从服务器的I/O线程。

### 4. 写入中继日志

- **写入操作**：从服务器的I/O线程接收到二进制日志事件后，会将这些事件写入本地的中继日志。中继日志是从服务器本地的一个日志文件，用于存储从主服务器接收到的所有二进制日志事件。

### 5. 应用日志事件

- **SQL线程应用更改**：从服务器上的另一个组件，SQL线程，负责读取中继日志中的事件并将它们应用到从服务器的数据库中，这样从服务器的数据就与主服务器保持一致了。

### 技术细节

- **心跳检测**：MySQL复制可以配置心跳检测（heartbeat），以验证主从连接的活跃状态，并帮助监控复制延迟。
- **半同步复制**：如果配置了半同步复制，从服务器在写入中继日志后，会向主服务器发送一个确认，主服务器在收到至少一个从服务器的确认后才会继续处理新的事务，这样提高了数据一致性。

通过这种方式，从服务器能够实时地知道主服务器上二进制日志的更新，并将这些更新同步到自己的中继日志中，进而保持与主服务器的数据一致性。

## 主服务器的bin dump thread的推送


### 二进制日志的推送过程

1. **复制连接建立**：当从服务器的I/O线程首次连接到主服务器时，它会请求从一个特定的二进制日志位置开始接收数据。这个位置是基于从服务器上已有的数据状态确定的。

2. **主动推送**：在主服务器上，当有新的数据变更（如一个SQL插入操作）被写入二进制日志后，主服务器并不是等待从服务器来“监听”这些变化。相反，主服务器上有一个专门的线程（在一些描述中被称为binlog dump thread），负责主动将这些新的二进制日志事件推送给已经建立连接并请求数据的从服务器。

3. **接收并写入中继日志**：从服务器的I/O线程接收到这些二进制日志事件后，将它们写入自己的中继日志中。然后，从服务器的SQL线程会读取中继日志，并执行里面的事件来更新从服务器的数据状态，以此保持与主服务器的数据一致。

所以，"监听"这个动作其实是一个从服务器发起连接请求后，主服务器主动推送二进制日志更新的过程。这种设计确保了数据变更能够有效、及时地从主服务器传播到从服务器，同时避免了从服务器需要不断轮询主服务器以检查数据变更的需求，这样可以更高效地利用网络和服务器资源。
